<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - VideoScript AI</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dashboard">
    <div class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1 class="logo">ğŸ¬ VideoScript AI</h1>
                <div class="user-info">
                    <div class="credits-badge" id="credits-display">
                        <span id="credits-count">0</span> ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ
                    </div>
                    <span id="user-email">user@example.com</span>
                    <button onclick="logout()" class="btn-secondary" style="padding: 8px 20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="container">
            <div class="projects-header">
                <h2 style="font-size: 32px;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h2>
                <a href="create.html" class="btn-primary">+ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</a>
            </div>

            <div id="alert-container"></div>

            <div id="loading" style="text-align: center; padding: 60px 0; display: none;">
                <p style="font-size: 18px; color: #636E72;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <div id="empty-state" style="text-align: center; padding: 80px 0; display: none;">
                <h3 style="font-size: 24px; margin-bottom: 20px; color: #636E72;">
                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã¾ã ã‚ã‚Šã¾ã›ã‚“
                </h3>
                <p style="color: #636E72; margin-bottom: 30px;">
                    æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã€AIã«å°æœ¬ã‚’ç”Ÿæˆã•ã›ã¾ã—ã‚‡ã†ï¼
                </p>
                <a href="create.html" class="btn-primary btn-large">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</a>
            </div>

            <div class="projects-grid" id="projects-grid"></div>
        </div>
    </div>

    <script>
        // âœ… API ãƒ™ãƒ¼ã‚¹ URL ã‚’ä¿®æ­£
        const API_BASE = 'https://videoscript-ai.totalgraphicarts.workers.dev';
        
        let token = localStorage.getItem('token');
        let userId = localStorage.getItem('userId');

        // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
        if (!token) {
            window.location.href = 'login.html';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
        window.addEventListener('DOMContentLoaded', async () => {
            await loadProfile();
            await loadProjects();
        });

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±å–å¾—
        async function loadProfile() {
            try {
                const response = await fetch(`${API_BASE}/api/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('user-email').textContent = data.email;
                    document.getElementById('credits-count').textContent = data.credits;
                } else if (response.status === 401) {
                    // ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
                    localStorage.removeItem('token');
                    localStorage.removeItem('userId');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
        async function loadProjects() {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const projectsGrid = document.getElementById('projects-grid');

            loading.style.display = 'block';
            emptyState.style.display = 'none';
            projectsGrid.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/projects`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });

                const projects = await response.json();

                loading.style.display = 'none';

                if (!projects || projects.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    projectsGrid.style.display = 'grid';
                    projectsGrid.innerHTML = projects.map(project => `
                        <div class="project-card">
                            <div class="project-title">${escapeHtml(project.title || 'ç„¡é¡Œã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ')}</div>
                            <div class="project-meta">
                                ${formatFramework(project.framework)} | ${project.duration}åˆ† | ${formatStyle(project.style)}
                            </div>
                            <div class="project-meta" style="margin-bottom: 15px;">
                                ä½œæˆæ—¥: ${formatDate(project.created_at)}
                            </div>
                            <span class="project-status status-${project.status}">
                                ${formatStatus(project.status)}
                            </span>
                            <div style="margin-top: 20px;">
                                <a href="create.html?id=${project.id}" class="btn-primary" style="padding: 10px 20px; font-size: 14px;">
                                    è©³ç´°
                                </a>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                loading.style.display = 'none';
                showAlert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            window.location.href = 'index.html';
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatFramework(framework) {
            const frameworks = {
                'threeAct': 'Three-Act',
                'cams': 'CAMS',
                'abcd': 'ABCD',
                'prep': 'PREP',
                'problemSolution': 'Problem-Solution',
                'customerJourney': 'Customer Journey'
            };
            return frameworks[framework] || framework;
        }

        function formatStyle(style) {
            const styles = {
                'professional': 'Professional',
                'casual': 'Casual',
                'educational': 'Educational',
                'entertaining': 'Entertaining'
            };
            return styles[style] || style;
        }

        function formatStatus(status) {
            const statuses = {
                'draft': 'ä¸‹æ›¸ã',
                'processing': 'ç”Ÿæˆä¸­',
                'completed': 'å®Œæˆ',
                'failed': 'å¤±æ•—'
            };
            return statuses[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>
